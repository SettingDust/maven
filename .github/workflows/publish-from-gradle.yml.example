# è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å·¥ä½œæµï¼Œå±•ç¤ºå¦‚ä½•ä»Ž Gradle é¡¹ç›®å‘å¸ƒæž„ä»¶åˆ°æ­¤ Maven ä»“åº“
# 
# ä½¿ç”¨æ–¹æ³•ï¼š
# 1. åœ¨ä½ çš„ Gradle é¡¹ç›®ä»“åº“ä¸­åˆ›å»º .github/workflows/publish.yml
# 2. å¤åˆ¶æ­¤æ–‡ä»¶å†…å®¹å¹¶æ ¹æ®éœ€è¦ä¿®æ”¹
# 3. é…ç½®å¿…è¦çš„ Secretsï¼ˆè§ä¸‹æ–¹è¯´æ˜Žï¼‰

name: Publish to Maven Repository

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Gradle é¡¹ç›®
        uses: actions/checkout@v4
        with:
          path: gradle-project

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'  # æ ¹æ®ä½ çš„é¡¹ç›®éœ€æ±‚ä¿®æ”¹
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Extract version from tag
        id: get_version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="SNAPSHOT"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: Build and publish to Maven Local
        working-directory: gradle-project
        run: |
          # è®¾ç½®ç‰ˆæœ¬ï¼ˆå¦‚æžœä½ çš„ build.gradle æ”¯æŒï¼‰
          ./gradlew publishToMavenLocal -Pversion=${{ steps.get_version.outputs.version }}
        env:
          GRADLE_OPTS: -Dorg.gradle.daemon=false

      - name: Checkout Maven ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: yourusername/github-maven  # ä¿®æ”¹ä¸ºä½ çš„ Maven ä»“åº“
          token: ${{ secrets.MAVEN_REPO_TOKEN }}  # éœ€è¦é…ç½® Personal Access Token
          path: maven-repo

      - name: Copy artifacts to Maven repository
        run: |
          # ä»Ž Maven Local å¤åˆ¶æž„ä»¶åˆ°ä»“åº“
          # Maven Local é»˜è®¤ä½ç½®ï¼š~/.m2/repository
          
          # å¤åˆ¶ä½ çš„æž„ä»¶ï¼ˆæ ¹æ®å®žé™… groupId å’Œ artifactId ä¿®æ”¹è·¯å¾„ï¼‰
          # ç¤ºä¾‹ï¼šcom.example:my-library
          SOURCE_PATH="$HOME/.m2/repository"
          TARGET_PATH="maven-repo/repository"
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶æ‰€æœ‰æ–°å‘å¸ƒçš„æž„ä»¶
          # æ–¹æ³•1ï¼šå¦‚æžœä½ çŸ¥é“å…·ä½“çš„ groupId
          GROUP_PATH="com/example"  # ä¿®æ”¹ä¸ºä½ çš„ groupIdï¼ˆç”¨ / åˆ†éš”ï¼‰
          if [ -d "$SOURCE_PATH/$GROUP_PATH" ]; then
            mkdir -p "$TARGET_PATH/$GROUP_PATH"
            cp -r "$SOURCE_PATH/$GROUP_PATH"/* "$TARGET_PATH/$GROUP_PATH/"
            echo "Copied artifacts from $GROUP_PATH"
          fi
          
          # æ–¹æ³•2ï¼šå¤åˆ¶æ‰€æœ‰å†…å®¹ï¼ˆå¦‚æžœæœ‰å¤šä¸ª groupIdï¼‰
          # rsync -av --exclude='*.repositories' "$SOURCE_PATH/" "$TARGET_PATH/"
          
          # æ˜¾ç¤ºå¤åˆ¶çš„æ–‡ä»¶
          echo "Published artifacts:"
          find "$TARGET_PATH" -name "*.jar" -o -name "*.pom" | sort

      - name: Commit and push to Maven repository
        working-directory: maven-repo
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add repository/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          COMMIT_MSG="å‘å¸ƒæž„ä»¶: ${{ github.repository }}@${{ steps.get_version.outputs.version }}

          æ¥æºä»“åº“: ${{ github.repository }}
          ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}
          æäº¤: ${{ github.sha }}
          è§¦å‘è€…: ${{ github.actor }}
          "
          
          git commit -m "$COMMIT_MSG"
          git push

      - name: Create release summary
        run: |
          echo "## ðŸ“¦ å‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**ä»“åº“:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ä½¿ç”¨æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
          echo '```xml' >> $GITHUB_STEP_SUMMARY
          echo '<dependency>' >> $GITHUB_STEP_SUMMARY
          echo '    <groupId>com.example</groupId>' >> $GITHUB_STEP_SUMMARY
          echo '    <artifactId>your-artifact</artifactId>' >> $GITHUB_STEP_SUMMARY
          echo '    <version>${{ steps.get_version.outputs.version }}</version>' >> $GITHUB_STEP_SUMMARY
          echo '</dependency>' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
