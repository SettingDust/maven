name: Publish to Maven Repository

on:
  push:
    tags:
      - 'v*'  # æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºå½“å‰é¡¹ç›®
      - name: Checkout project
        uses: actions/checkout@v4

      # 2. è®¾ç½® JDK
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. è®¾ç½® Gradle
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      # 4. ä»æ ‡ç­¾æå–ç‰ˆæœ¬å·
      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="SNAPSHOT"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Publishing version: $VERSION"

      # 5. å‘å¸ƒåˆ° Maven Local
      - name: Publish to Maven Local
        run: ./gradlew publishToMavenLocal -Pversion=${{ steps.version.outputs.version }} --no-daemon
        
      # 6. éªŒè¯å‘å¸ƒç»“æœ
      - name: Verify published artifacts
        run: |
          echo "ğŸ“‹ Published artifacts:"
          find ~/.m2/repository/com/example -type f \( -name "*.jar" -o -name "*.pom" \) | sort

      # 7. æ£€å‡º Maven ä»“åº“
      - name: Checkout Maven repository
        uses: actions/checkout@v4
        with:
          repository: yourusername/github-maven  # æ›¿æ¢ä¸ºä½ çš„ Maven ä»“åº“
          token: ${{ secrets.MAVEN_REPO_TOKEN }}
          path: maven-repo

      # 8. å¤åˆ¶æ„ä»¶åˆ° Maven ä»“åº“
      - name: Copy artifacts to repository
        run: |
          # å®šä¹‰æºå’Œç›®æ ‡è·¯å¾„
          GROUP_ID="com/example"  # æ›¿æ¢ä¸ºä½ çš„ groupId
          SOURCE_PATH="$HOME/.m2/repository/$GROUP_ID"
          TARGET_PATH="maven-repo/repository/$GROUP_ID"
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p "$TARGET_PATH"
          
          # å¤åˆ¶æ„ä»¶
          if [ -d "$SOURCE_PATH" ]; then
            cp -rv "$SOURCE_PATH"/* "$TARGET_PATH/"
            echo "âœ… Successfully copied artifacts"
          else
            echo "âŒ Source path not found: $SOURCE_PATH"
            exit 1
          fi
          
          # æ˜¾ç¤ºå¤åˆ¶çš„æ–‡ä»¶
          echo "ğŸ“¦ Copied artifacts:"
          find "$TARGET_PATH" -type f \( -name "*.jar" -o -name "*.pom" \) | sort

      # 9. æäº¤å¹¶æ¨é€åˆ° Maven ä»“åº“
      - name: Commit and push to Maven repository
        working-directory: maven-repo
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # æ·»åŠ å˜æ›´
          git add repository/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
            exit 0
          fi
          
          # æäº¤
          cat > commit_message.txt << EOF
          ğŸ“¦ å‘å¸ƒæ„ä»¶: ${{ github.repository }}@${{ steps.version.outputs.version }}
          
          ğŸ”– ç‰ˆæœ¬: ${{ steps.version.outputs.version }}
          ğŸ“ ä»“åº“: ${{ github.repository }}
          ğŸ”— æäº¤: ${{ github.sha }}
          ğŸ‘¤ å‘å¸ƒè€…: ${{ github.actor }}
          â° æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
          
          git commit -F commit_message.txt
          git push
          
          echo "âœ… Successfully published to Maven repository"

      # 10. åˆ›å»ºå‘å¸ƒæ‘˜è¦
      - name: Create release summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ğŸ“¦ å‘å¸ƒæˆåŠŸ
          
          **ç‰ˆæœ¬:** \`${{ steps.version.outputs.version }}\`  
          **é¡¹ç›®:** \`${{ github.repository }}\`  
          **æäº¤:** \`${{ github.sha }}\`
          
          ### ğŸ“‹ Maven ä¾èµ–é…ç½®
          
          \`\`\`xml
          <dependency>
              <groupId>com.example</groupId>
              <artifactId>example-library</artifactId>
              <version>${{ steps.version.outputs.version }}</version>
          </dependency>
          \`\`\`
          
          ### ğŸ”§ Gradle ä¾èµ–é…ç½®
          
          \`\`\`kotlin
          implementation("com.example:example-library:${{ steps.version.outputs.version }}")
          \`\`\`
          
          ### ğŸŒ ä»“åº“åœ°å€
          
          æŸ¥çœ‹ç´¢å¼•é¡µé¢: [Maven Repository](https://yourusername.github.io/github-maven/)
          EOF
